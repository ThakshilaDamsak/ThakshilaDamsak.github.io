<!---------This style should be added to force the footer background--------->

<style>
  @media screen and (max-height: 495px) {

    .content .footer {
        border-width: 1px 0px 0px 0px;
        border-color: rgba(138, 138, 138, 0.226);
        border-style: solid;
        box-shadow: 0px -8px 12px 0px rgba(0, 0, 0, 0.048);
        background-color: var(--footer-bg);
        backdrop-filter: blur(20px) saturate(3);
        -webkit-backdrop-filter: blur(20px) saturate(3);
    }        
  }
</style>

<div class="generator-page">
  <div class="headerarea">
    <div class="headerimage">
      <img src="/images/CSS-FIlter-Color.svg" alt="[Project Logo]">
    </div>
    <div class="titlearea">
      <div class="title">Color Filter Generator</div>
      <div class="description">Generate CSS filters for black icons.</div>
      <div class="description" id="about"><a href="#what-da-hail">Help! What is this! <iconify-icon icon="material-symbols:help"></iconify-icon></a></div>
    </div>
  </div>

  <div class="generator g1" id="generator1">
    <div class="input-preview-area">
      <div class="inputarea">
          <div class="inputtitle">
              <span>Enter</span>
              <select id="color-method">
                <option value="#picker">Picker</option>
                <option value="#hex">HEX</option>
                <option value="#rgb">RGB</option>
            </select>
              <span>Value</span>
          </div>
          <div class="hr"></div>
          <div class="inputactions">
              <div class="colorpicker-container" id="cp-container-:)" style="cursor: pointer;">
                <input class="colorpicker" id="color-picker" style="cursor: pointer;" type="color" value="#d028c8" />
                <div class="colorpicker-icon" id="color-picker-butt"><span><iconify-icon icon="pepicons-pop:color-picker-circle-filled"></iconify-icon></span></div>
              </div>
              <input class="target" id="target" type="text" style="visibility: hidden; position: absolute; opacity: 0;" placeholder="#hex" value="#d028c8" />
              <input class="input" id="input" type="text" style="visibility: hidden; position: absolute; opacity: 0;" placeholder="r, g, b" value="208, 40, 200" />
              <button class="execute regular-button">Compute Filters</button>
          </div>
      </div>
      <div class="previewarea">
        <div class="previewarea-item">
          <div class="previewarea-title">
            <span>
              <p class="preview-title">Real pixel</p>
              <p class="preview-text">Color applied through CSS background-color:</p>
            </span>
          </div>
              <div class="pixel realPixel"></div>
        </div>
        <div class="previewarea-item">
          <div class="previewarea-title">
            <span>
              <p class="preview-title">Filtered pixel</p>
              <p class="preview-text">Color applied through CSS filter:</p>
            </span>
          </div>
              <div class="pixel filterPixel"></div>
        </div>
      </div>
    </div>
    <div class="outputarea">
      <div class="filteroutput">
        <p class="filterDetail" id="filterDetail"><i class="placeholder">Click "Compute Filters"</i></p>
      </div>
      <div class="filterStuff">
      <p class="lossDetail"><iconify-icon icon="icon-park-solid:up-two"></iconify-icon></p>
      <button class="regular-button" id="copy-button"><span class="buttontext">Copy</span></button>
      </div>
    </div>

  </div>

  
  <div class="generator" id="generator2" style="display: none;">
    <div class="input-preview-area">
      <div class="inputarea infotext">
          <div class="info">
            <h2>About</h2>
            <p style="display: inline;">Color Filter Generator is a small website that lets you convert any color to a CSS filter that you can apply to black images and icons. You can easily create and copy CSS color filters and give your
              <u class="tooltip">
                <u style="text-decoration:dotted; text-decoration-line: underline;">website</u>
                <span class="tooltiptext">or whatever you create</span>
              </u>
              a unique look.</p>
            <br>
            <br>
            <p>Example:</p>
            <br>
            <div class="what-images">
              <div class="image1">
                <div class="img">
                  <img src="/images/logo-long-bk.svg" alt="[Image]">
                </div>
                <span>Nomral Image</span>
                <sup><p>Without Filter</p></sup>
              </div>
              <div class="image2">
                <div class="img">
                  <img src="/images/logo-long-bk.svg" alt="[Image]">
                </div>
                <span>Colored Image</span>

                <div class="tooltip">
                  <sup><u style="text-decoration:dotted; text-decoration-line: underline;">With Pink Color Filter</u></sup>
                  <span class="tooltiptext"><code class="codeblock" data-attr="CSS" style="background-color: transparent; border: none;" >filter: invert(23%) sepia(46%) saturate(5952%) hue-rotate(290deg) brightness(95%) contrast(90%);</code></span>
                </div>

              </div>
            </div>
            <br>
            <h2>How it works</h2>
            <p>Color Filter Generator uses a simple algorithm<sup>1</sup> to calculate the hue, saturation, brightness,â€¦ values of any color you choose and generate a corresponding CSS filter. You can copy and paste the filter code into your style sheet and use it for any black image or icon on your website.</p>
            <br>
            <h2>FAQs</h2>
            <br>
            <h4>Why do I need to use black images or icons?</h4>
            <p>The algorithm is made for black images because they are common for icons. If your image or icon is not black, you can prepend <code>brightness(0) saturate(100%)</code> to your filter property, which will turn it to black before applying the color filter.<sup>2</sup></p>
            <br>
            <h4>How can I choose a color for the filter?</h4>
            <p>You can choose a color for the filter by using one of the three methods available on the website:</p>
            <ul>
              <li>Color picker: You can use the color picker tool to select any color from the palette.</li>
              <li>Hex code: You can enter the hex code of the color you want in the input box. For example, if you want a red filter, you can enter <code>#FF0000</code> as the hex code.</li>
              <li>RGB values: You can enter the red, green, and blue values of the color you want in the input boxes. For example, if you want a red filter, you can enter <code>255</code> for red, <code>0</code> for green, and <code>0</code> for blue.</li>
            </ul>
            <p>After choosing a color, you can copy and paste the filter code into your style sheet.</p>            <br>
            <h4>Can I use Color Filter for other purposes besides coloring images or icons?</h4>
            <p>Yes, you can use Color Filter for any element that supports the CSS filter property, such as text, backgrounds, borders, etc. However, keep in mind that the filter will affect the entire element, not just the color. For example, if you apply a filter to a text element, it will also change the brightness and contrast of the text.</p>
            <br>
            <p>This website is based on following sources:</p>
            <br>
            <ul class="source-links">
            <li><a href="https://stackoverflow.com/a/43960991/604861" target="_blank">Stack Overflow. (2017, May 9). How to apply a color filter to a grayscale image using only CSS?.<sup>1</sup></a></li>
            <li><a href="https://codepen.io/sosuke/pen/Pjoqqp" target="_blank">Sosuke. (2016, June 15). CSS Color Filter Generator [Codepen].<sup>2</sup></a></li>
            </ul>
          </div>
      </div>
    </div>

  </div>

</div>



<script>
  // get the image element by its id
var image = document.getElementById("color-picker-butt");

// get the color picker element by its id
var cPicker = document.getElementById("color-picker");

// add a click event listener to the image element
image.addEventListener("click", function() {
  // trigger a click event on the color picker element
  cPicker.click();
});
</script>

<script>
  // Get the buttons with the class .sort-button
  let buttons = document.getElementsByClassName("description");
  
  // Get the page elements with the ids .page1 and .page2
  let generator1 = document.getElementById("generator1");
  let generator2 = document.getElementById("generator2");
  let about = document.getElementById("about");
  let footerStyles = document.getElementById("footer");
  
  // Define a function that changes the page state and the URL
  function changePageState() {
    // Get the current path without the hash
    let path = window.location.pathname;
  
    // Get the current hash, if any
    let hash = window.location.hash;
  
    // Check if the hash is #sort-projects
    if (hash === "#what-da-hail") {
      // If yes, remove it from the hash
      hash = "";
      history.pushState(null, "", path);
    } else {
      // If no, add it to the hash
      hash = "#what-da-hail";
      history.pushState(null, "", path + hash);
    }
  
    // Change the URL without reloading the page
  
    // Toggle the display of pages
    togglePages();
  }
  
  function changePageStateStartup() {
    // Get the current path without the hash
    let path = window.location.pathname;
  
    // Get the current hash, if any
    let hash = window.location.hash;
  
    // Check if the hash is #sort-projects
    if (hash === "#what-da-hail") {
      // If yes, remove it from the hash
      hash = "#what-da-hail";
    } else {
      // If no, add it to the hash
      hash = "#what-da-hail";
    }
  
    // Toggle the display of pages
    togglePages();
  }
  
  // Function to toggle the display of pages
  function togglePages() {
    // Get the full URL of the current page
    let url = window.location.href;
  
    // Check if the URL contains the #sort-projects parameter
    if (url.includes("#what-da-hail")) {
      // If yes, hide page1 and show page2
      generator1.style.display = "none";
      generator2.style.display = "flex";
      footerStyles.classList.add("footer-acrylic-force");
      about.innerHTML = '<a onclick="togglePages()" style="cursor:pointer;">Go back! <iconify-icon icon="pajamas:go-back"></iconify-icon></a>';
      subdirectory.innerHTML = '<a href="/projects/" class="header-path">/projects/</a><a onclick="changePageState()" style="cursor:pointer;" class="header-path">color-filter-generator/</a>';
  
      } else {
      // If no, show page1 and hide page2
      generator1.style.display = "flex";
      generator2.style.display = "none";
      footerStyles.classList.remove("footer-acrylic-force");
      subdirectory.innerHTML = '<a href="/projects/" class="header-path">/projects/</a>';
      about.innerHTML = '<a onclick="togglePages()" style="cursor:pointer;">Help! What is this! <iconify-icon icon="material-symbols:help"></iconify-icon></a>';      
    }
  }
  
  // Loop through each button and add an event listener
  for (let button of buttons) {
    button.addEventListener("click", changePageState);
  }
  
  // Check if the URL has the #sort-projects hash when the page loads
  if (window.location.hash === "#what-da-hail") {
    // If yes, call the function to change the page state and the URL
    changePageStateStartup();
  }
  
  </script>

<script>
  // Get the select element by its id
let select = document.getElementById("color-method");

// Add an event listener for the change event
select.addEventListener("change", function() {
  // Get the selected value
  let value = select.value;

  // Get the elements by their id
  let generator1 = document.getElementById("generator1");
  let generator2 = document.getElementById("generator2");
  let hextarget = document.getElementById("target");
  let cpcontainer = document.getElementById("cp-container-:)");
  let rgbinput = document.getElementById("input");
  let footerStyles = document.getElementById("footer");
  let about = document.getElementById("about");

  // Use a switch statement to handle different values
  switch (value) {
    case "#hex":
      generator1.style.display = "flex";
      generator2.style.display = "none";
      hextarget.style.visibility = "visible";
      hextarget.style.position = "relative";
      hextarget.style.opacity = "1";
      cpcontainer.style.visibility = "hidden";
      cpcontainer.style.position = "absolute";
      cpcontainer.style.opacity = "0";
      rgbinput.style.visibility = "hidden";
      rgbinput.style.position = "absolute";
      rgbinput.style.opacity = "0";
      selectBox.value = "#hex";
      footerStyles.classList.remove("footer-acrylic-force");
      about.innerHTML = '<a href="#what-da-hail">Help! What is this! <iconify-icon icon="material-symbols:help"></iconify-icon></a>';
      break;
    case "#rgb":
      generator1.style.display = "flex";
      generator2.style.display = "none";
      hextarget.style.visibility = "hidden";
      hextarget.style.position = "absolute";
      hextarget.style.opacity = "0";
      rgbinput.style.visibility = "visible";
      rgbinput.style.position = "relative";
      rgbinput.style.opacity = "1";
      cpcontainer.style.visibility = "hidden";
      cpcontainer.style.position = "absolute";
      cpcontainer.style.opacity = "0";
      selectBox.value = "#rgb";
      footerStyles.classList.remove("footer-acrylic-force");
      about.innerHTML = '<a href="#what-da-hail">Help! What is this! <iconify-icon icon="material-symbols:help"></iconify-icon></a>';
      break;
    default :
      generator1.style.display = "flex";
      generator2.style.display = "none";
      cpcontainer.style.visibility = "visible";
      cpcontainer.style.position = "relative";
      cpcontainer.style.opacity = "1";
      hextarget.style.visibility = "hidden";
      hextarget.style.position = "absolute";
      hextarget.style.opacity = "0";
      rgbinput.style.visibility = "hidden";
      rgbinput.style.position = "absolute";
      rgbinput.style.opacity = "0";
      selectBox.value = "#picker";
      footerStyles.classList.remove("footer-acrylic-force");
      about.innerHTML = '<a href="#what-da-hail">Help! What is this! <iconify-icon icon="material-symbols:help"></iconify-icon></a>';
      break;
  }
});

</script>


<script>
// Get the input and target elements by their id
let input = document.getElementById("input");
let target = document.getElementById("target");

// Get the color picker element by its id
let colorPicker = document.getElementById("color-picker");

// Define a function to convert a single RGB component to hex
function componentToHex(c) {
  let hex = c.toString(16);
  return hex.length == 1 ? "0" + hex : hex;
}

// Define a function to convert RGB to hex
function rgbToHex(r, g, b) {
  return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
}

// Define a function to convert a single hex component to decimal
function hexToDecimal(h) {
  return parseInt(h, 16);
}

// Define a function to convert hex to RGB
function hexToRGB(hex) {
  // Remove the leading #
  hex = hex.slice(1);
  // Split the hex string into three parts
  let r = hex.slice(0, 2);
  let g = hex.slice(2, 4);
  let b = hex.slice(4, 6);
  // Convert each part to decimal
  r = hexToDecimal(r);
  g = hexToDecimal(g);
  b = hexToDecimal(b);
  // Return an array of three numbers
  return [r, g, b];
}

// Define a function to get the RGB value from the input element
function getRGB() {
  // Get the value of the input element
  let value = input.value;
  // Split the value by comma and map each part to a number
  let rgb = value.split(",").map(Number);
  // Return an array of three numbers
  return rgb;
}

// Define a function to get the hex value from the target element
function getHex() {
  // Get the value of the target element
  let value = target.value;
  // Return a string
  return value;
}

// Define a function to validate the RGB value
function isValidRGB(rgb) {
  // Check if the array has three elements
  if (rgb.length != 3) {
    return false;
  }
  // Check if each element is a number between 0 and 255
  for (let c of rgb) {
    if (isNaN(c) || c < 0 || c > 255) {
      return false;
    }
  }
  // Return true if all checks pass
  return true;
}

// Define a function to validate the hex value
function isValidHex(hex) {
  // Check if the string has a leading #
  if (hex[0] != "#") {
    return false;
  }
  // Check if the string has six characters after the #
  if (hex.length != 7) {
    return false;
  }
  // Check if each character is a valid hex digit
  for (let i = 1; i < hex.length; i++) {
    let c = hex[i];
    if (!c.match(/[0-9a-fA-F]/)) {
      return false;
    }
  }
  // Return true if all checks pass
  return true;
}

// Define a function to set the hex value to the target element
function setHex() {
  // Get the RGB value from the input element
  let rgb = getRGB();
  // Check if the RGB value is valid
  if (isValidRGB(rgb)) {
    // Convert the RGB value to hex
    let hex = rgbToHex(rgb[0], rgb[1], rgb[2]);
    // Set the value of the target element to the hex value
    target.value = hex;
    // Set the value of the color picker element to the hex value
    colorPicker.value = hex;
  } else {
    // Set the value of the target element to "NaNaNa" if the RGB value is invalid
    target.value = "NaNaNa";
  }
}

// Define a function to set the RGB value to the input element
function setRGB() {
  // Get the hex value from the target element
  let hex = getHex();
  // Check if the hex value is valid
  if (isValidHex(hex)) {
    // Convert the hex value to RGB
    let rgb = hexToRGB(hex);
    // Join the RGB array with commas
    let rgbString = rgb.join(",");
    // Set the value of the input element to the RGB string
    input.value = rgbString;
    // Set the value of the color picker element to the hex value
    colorPicker.value = hex;
  } else {
    // Set the value of the input element to "NaNaNa" if the hex value is invalid
    input.value = "NaNaNa";
  }
}

// Define a function to set the hex value from the color picker to the target element
function setHexFromPicker() {
  // Get the hex value from the color picker element
  let hex = colorPicker.value;
  // Set the value of the target element to the hex value
  target.value = hex;
  // Set the value of the input element to the corresponding RGB value
  setRGB();
}

// Add an event listener to the input element that fires when the value changes
input.addEventListener("input", setHex);

// Add an event listener to the target element that fires when the value changes
target.addEventListener("input", setRGB);

// Add an event listener to the color picker element that fires when the value changes
colorPicker.addEventListener("input", setHexFromPicker);

// Define a function to sync the input and target elements based on their display property
function syncInputAndTarget() {
  // Get the display property of the input element
  let inputDisplay = input.style.display;
  // Get the display property of the color picker element
  let pickerDisplay = colorPicker.style.display;
  // Check if the input element is flex
  if (inputDisplay == "flex") {
    // Call the setHex function to sync the input and target elements
    setHex();
  }
  // Check if the target element is flex
  if (targetDisplay == "flex") {
    // Call the setRGB function to sync the target and input elements
    setRGB();
  }
  // Check if the color picker element is flex
  if (pickerDisplay == "flex") {
    // Call the setHexFromPicker function to sync the color picker and target elements
    setHexFromPicker();
  }
}

// Add an event listener to the window that fires when the page loads
window.addEventListener("load", syncInputAndTarget);

</script>

<script>
// Get the button element
var btn = document.querySelector ("#copy-button");
var btntext = document.querySelector (".buttontext")

// Add a click event listener to the button
btn.addEventListener ("click", function () {
  // Get the p#filterDetail element
  var p = document.getElementById ("filterDetail");

  // Check if the p element has the .placeholder class as a child element
  var placeholder = p.querySelector (".placeholder");

  // If yes, then add the .highlight class to the .placeholder element
  if (placeholder) {
    placeholder.classList.add ("highlight");
    setTimeout(() => {
        placeholder.classList.remove ("highlight");
        }, 1000);
  } else {
    // If no, then do the copy action code as before
    // Check if the p element has any text content
    if (p.textContent) {
      // Copy the text content to the clipboard
      navigator.clipboard.writeText (p.textContent);
      btntext.style.opacity = "0";

      setTimeout(() => {
          btntext.innerHTML = "Copied!";
        }, 100);

        setTimeout(() => {
          btntext.style.opacity = "1";
        }, 200);

        setTimeout(() => {
          btntext.style.opacity = "0";
        }, 800);

        setTimeout(() => {
          btntext.innerHTML = "Copy";
        }, 900);

      setTimeout(() => {
          btntext.style.opacity = "1";
        }, 1000);
    }
  }
});
</script>

<script>
    'use strict';

class Color {
  constructor(r, g, b) {
    this.set(r, g, b);
  }
  
  toString() {
    return `rgb(${Math.round(this.r)}, ${Math.round(this.g)}, ${Math.round(this.b)})`;
  }

  set(r, g, b) {
    this.r = this.clamp(r);
    this.g = this.clamp(g);
    this.b = this.clamp(b);
  }

  hueRotate(angle = 0) {
    angle = angle / 180 * Math.PI;
    const sin = Math.sin(angle);
    const cos = Math.cos(angle);

    this.multiply([
      0.213 + cos * 0.787 - sin * 0.213,
      0.715 - cos * 0.715 - sin * 0.715,
      0.072 - cos * 0.072 + sin * 0.928,
      0.213 - cos * 0.213 + sin * 0.143,
      0.715 + cos * 0.285 + sin * 0.140,
      0.072 - cos * 0.072 - sin * 0.283,
      0.213 - cos * 0.213 - sin * 0.787,
      0.715 - cos * 0.715 + sin * 0.715,
      0.072 + cos * 0.928 + sin * 0.072,
    ]);
  }

  grayscale(value = 1) {
    this.multiply([
      0.2126 + 0.7874 * (1 - value),
      0.7152 - 0.7152 * (1 - value),
      0.0722 - 0.0722 * (1 - value),
      0.2126 - 0.2126 * (1 - value),
      0.7152 + 0.2848 * (1 - value),
      0.0722 - 0.0722 * (1 - value),
      0.2126 - 0.2126 * (1 - value),
      0.7152 - 0.7152 * (1 - value),
      0.0722 + 0.9278 * (1 - value),
    ]);
  }

  sepia(value = 1) {
    this.multiply([
      0.393 + 0.607 * (1 - value),
      0.769 - 0.769 * (1 - value),
      0.189 - 0.189 * (1 - value),
      0.349 - 0.349 * (1 - value),
      0.686 + 0.314 * (1 - value),
      0.168 - 0.168 * (1 - value),
      0.272 - 0.272 * (1 - value),
      0.534 - 0.534 * (1 - value),
      0.131 + 0.869 * (1 - value),
    ]);
  }

  saturate(value = 1) {
    this.multiply([
      0.213 + 0.787 * value,
      0.715 - 0.715 * value,
      0.072 - 0.072 * value,
      0.213 - 0.213 * value,
      0.715 + 0.285 * value,
      0.072 - 0.072 * value,
      0.213 - 0.213 * value,
      0.715 - 0.715 * value,
      0.072 + 0.928 * value,
    ]);
  }

  multiply(matrix) {
    const newR = this.clamp(this.r * matrix[0] + this.g * matrix[1] + this.b * matrix[2]);
    const newG = this.clamp(this.r * matrix[3] + this.g * matrix[4] + this.b * matrix[5]);
    const newB = this.clamp(this.r * matrix[6] + this.g * matrix[7] + this.b * matrix[8]);
    this.r = newR;
    this.g = newG;
    this.b = newB;
  }

  brightness(value = 1) {
    this.linear(value);
  }
  contrast(value = 1) {
    this.linear(value, -(0.5 * value) + 0.5);
  }

  linear(slope = 1, intercept = 0) {
    this.r = this.clamp(this.r * slope + intercept * 255);
    this.g = this.clamp(this.g * slope + intercept * 255);
    this.b = this.clamp(this.b * slope + intercept * 255);
  }

  invert(value = 1) {
    this.r = this.clamp((value + this.r / 255 * (1 - 2 * value)) * 255);
    this.g = this.clamp((value + this.g / 255 * (1 - 2 * value)) * 255);
    this.b = this.clamp((value + this.b / 255 * (1 - 2 * value)) * 255);
  }

  hsl() {
    // Code taken from https://stackoverflow.com/a/9493060/2688027, licensed under CC BY-SA.
    const r = this.r / 255;
    const g = this.g / 255;
    const b = this.b / 255;
    const max = Math.max(r, g, b);
    const min = Math.min(r, g, b);
    let h, s, l = (max + min) / 2;

    if (max === min) {
      h = s = 0;
    } else {
      const d = max - min;
      s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
      switch (max) {
        case r:
          h = (g - b) / d + (g < b ? 6 : 0);
          break;

        case g:
          h = (b - r) / d + 2;
          break;

        case b:
          h = (r - g) / d + 4;
          break;
      }
      h /= 6;
    }

    return {
      h: h * 100,
      s: s * 100,
      l: l * 100,
    };
  }

  clamp(value) {
    if (value > 255) {
      value = 255;
    } else if (value < 0) {
      value = 0;
    }
    return value;
  }
}

class Solver {
  constructor(target, baseColor) {
    this.target = target;
    this.targetHSL = target.hsl();
    this.reusedColor = new Color(0, 0, 0);
  }

  solve() {
    const result = this.solveNarrow(this.solveWide());
    return {
      values: result.values,
      loss: result.loss,
      filter: this.css(result.values),
    };
  }

  solveWide() {
    const A = 5;
    const c = 15;
    const a = [60, 180, 18000, 600, 1.2, 1.2];

    let best = { loss: Infinity };
    for (let i = 0; best.loss > 25 && i < 3; i++) {
      const initial = [50, 20, 3750, 50, 100, 100];
      const result = this.spsa(A, a, c, initial, 1000);
      if (result.loss < best.loss) {
        best = result;
      }
    }
    return best;
  }

  solveNarrow(wide) {
    const A = wide.loss;
    const c = 2;
    const A1 = A + 1;
    const a = [0.25 * A1, 0.25 * A1, A1, 0.25 * A1, 0.2 * A1, 0.2 * A1];
    return this.spsa(A, a, c, wide.values, 500);
  }

  spsa(A, a, c, values, iters) {
    const alpha = 1;
    const gamma = 0.16666666666666666;

    let best = null;
    let bestLoss = Infinity;
    const deltas = new Array(6);
    const highArgs = new Array(6);
    const lowArgs = new Array(6);

    for (let k = 0; k < iters; k++) {
      const ck = c / Math.pow(k + 1, gamma);
      for (let i = 0; i < 6; i++) {
        deltas[i] = Math.random() > 0.5 ? 1 : -1;
        highArgs[i] = values[i] + ck * deltas[i];
        lowArgs[i] = values[i] - ck * deltas[i];
      }

      const lossDiff = this.loss(highArgs) - this.loss(lowArgs);
      for (let i = 0; i < 6; i++) {
        const g = lossDiff / (2 * ck) * deltas[i];
        const ak = a[i] / Math.pow(A + k + 1, alpha);
        values[i] = fix(values[i] - ak * g, i);
      }

      const loss = this.loss(values);
      if (loss < bestLoss) {
        best = values.slice(0);
        bestLoss = loss;
      }
    }
    return { values: best, loss: bestLoss };

    function fix(value, idx) {
      let max = 100;
      if (idx === 2 /* saturate */) {
        max = 7500;
      } else if (idx === 4 /* brightness */ || idx === 5 /* contrast */) {
        max = 200;
      }

      if (idx === 3 /* hue-rotate */) {
        if (value > max) {
          value %= max;
        } else if (value < 0) {
          value = max + value % max;
        }
      } else if (value < 0) {
        value = 0;
      } else if (value > max) {
        value = max;
      }
      return value;
    }
  }

  loss(filters) {
    // Argument is array of percentages.
    const color = this.reusedColor;
    color.set(0, 0, 0);

    color.invert(filters[0] / 100);
    color.sepia(filters[1] / 100);
    color.saturate(filters[2] / 100);
    color.hueRotate(filters[3] * 3.6);
    color.brightness(filters[4] / 100);
    color.contrast(filters[5] / 100);

    const colorHSL = color.hsl();
    return (
      Math.abs(color.r - this.target.r) +
      Math.abs(color.g - this.target.g) +
      Math.abs(color.b - this.target.b) +
      Math.abs(colorHSL.h - this.targetHSL.h) +
      Math.abs(colorHSL.s - this.targetHSL.s) +
      Math.abs(colorHSL.l - this.targetHSL.l)
    );
  }

  css(filters) {
    function fmt(idx, multiplier = 1) {
      return Math.round(filters[idx] * multiplier);
    }
    return `filter: invert(${fmt(0)}%) sepia(${fmt(1)}%) saturate(${fmt(2)}%) hue-rotate(${fmt(3, 3.6)}deg) brightness(${fmt(4)}%) contrast(${fmt(5)}%);`;
  }
}

function hexToRgb(hex) {
  // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
  const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
  hex = hex.replace(shorthandRegex, (m, r, g, b) => {
    return r + r + g + g + b + b;
  });

  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result
    ? [
      parseInt(result[1], 16),
      parseInt(result[2], 16),
      parseInt(result[3], 16),
    ]
    : null;
}

$(document).ready(() => {
  $('button.execute').click(() => {
    const rgb = hexToRgb($('input.target').val());
    if (rgb.length !== 3) {
      alert('Invalid format!');
      return;
    }

    const color = new Color(rgb[0], rgb[1], rgb[2]);
    const solver = new Solver(color);
    const result = solver.solve();

    let lossMsg;
    if (result.loss < 1) {
      lossMsg = 'This is a perfect result.';
    } else if (result.loss < 5) {
      lossMsg = 'The is close enough.';
    } else if (result.loss < 15) {
      lossMsg = 'The color is somewhat off. Consider running it again.';
    } else {
      lossMsg = 'The color is extremely off. Run it again!';
    }

    $('.realPixel').css('background-color', color.toString());
    $('.filterPixel').attr('style', result.filter);
    $('.filterDetail').text(result.filter);
    $('.lossDetail').html(`Loss: ${result.loss.toFixed(1)}. <b>${lossMsg}</b>`);
  });
});

</script>